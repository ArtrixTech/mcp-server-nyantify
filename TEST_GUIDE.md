# Nyantify MCP 完整测试指南

## 测试目标
确保所有功能正常工作，包括 IDE 焦点检测、任务计时、通知发送。

---

## 前置准备

1. 确保 OpenCode 已重启并加载 nyantify MCP
2. 确保 Bark App 已安装且推送已开启
3. 确保测试环境是 macOS（用于 IDE 焦点检测）

---

## 测试 1: 直接通知功能

### 测试步骤

**步骤 1.1** - 使用 notify 工具发送测试通知
```
调用 nyantify_notify，发送一条测试通知
标题: Nyantify
内容: 测试通知功能 - 这是一条测试消息
级别: timeSensitive
```

**步骤 1.2** - 用户操作
👤 **用户请检查**: 查看你的 iPhone 是否收到 Bark 推送通知
- 确认标题为 "Nyantify"
- 确认内容为 "测试通知功能 - 这是一条测试消息"

**步骤 1.3** - 验证
如果收到通知 → ✅ 测试通过
如果没收到 → ❌ 检查 Bark Key 是否正确

---

## 测试 2: 短任务（<1分钟）不通知

### 测试步骤

**步骤 2.1** - 开始任务
```
调用 nyantify_start_task
任务ID: short-task-001
任务名称: 短任务测试（不应通知）
```

**步骤 2.2** - 等待 5-10 秒

**步骤 2.3** - 结束任务
```
调用 nyantify_end_task
任务ID: short-task-001
```

**步骤 2.4** - 用户操作
👤 **用户请确认**: 确认你的 iPhone **没有**收到通知

**步骤 2.5** - 验证
- 预期结果: 不会收到通知（任务时长 < 60 秒）
- 如果收到通知 → ❌ 逻辑错误
- 如果没收到通知 → ✅ 测试通过

---

## 测试 3: 长任务（>1分钟）且用户不在 IDE 时通知

### 测试步骤

**步骤 3.1** - 开始任务
```
调用 nyantify_start_task
任务ID: long-task-001
任务名称: 长任务测试（应通知）
```

**步骤 3.2** - 用户操作（关键！）
👤 **用户请操作**: 
- 点击你的浏览器或其他非 IDE 应用窗口（如 Chrome、Safari）
- 让浏览器成为当前焦点窗口
- 等待约 70 秒（可以使用手机计时）

**步骤 3.3** - 结束任务（确保等待超过 60 秒）
```
调用 nyantify_end_task
任务ID: long-task-001
```

**步骤 3.4** - 用户操作
👤 **用户请检查**: 查看你的 iPhone 是否收到通知
- 预期: 应该收到 "Task Completed" 通知
- 通知内容: "长任务测试（应通知）" finished after XXs

**步骤 3.5** - 验证
如果收到通知 → ✅ 测试通过
如果没收到通知 → ❌ 检查配置或 IDE 检测逻辑

---

## 测试 4: 长任务但用户在 IDE 时不通知

### 测试步骤

**步骤 4.1** - 用户操作（关键！）
👤 **用户请操作**: 
- 回到你的 IDE 窗口（VS Code/Cursor/IntelliJ 等）
- 确保 IDE 是当前焦点窗口

**步骤 4.2** - 开始任务
```
调用 nyantify_start_task
任务ID: focused-task-001
任务名称: 长任务IDE聚焦测试（不应通知）
```

**步骤 4.3** - 用户操作（关键！）
👤 **用户请保持**: 
- 保持在 IDE 中工作（不要切换到其他应用）
- 等待约 70 秒

**步骤 4.4** - 结束任务（确保等待超过 60 秒）
```
调用 nyantify_end_task
任务ID: focused-task-001
```

**步骤 4.5** - 用户操作
👤 **用户请确认**: 确认你的 iPhone **没有**收到通知

**步骤 4.6** - 验证
- 预期结果: 不会收到通知（虽然任务 >60s，但用户正在 IDE 中）
- 如果收到通知 → ❌ IDE 检测失败
- 如果没收到通知 → ✅ 测试通过

---

## 测试 5: 强制通知功能

### 测试步骤

**步骤 5.1** - 回到 IDE 窗口
👤 **用户请操作**: 确保当前焦点是 IDE 窗口

**步骤 5.2** - 开始任务
```
调用 nyantify_start_task
任务ID: force-task-001
任务名称: 强制通知测试
```

**步骤 5.3** - 等待 5-10 秒

**步骤 5.4** - 强制结束并通知
```
调用 nyantify_end_task
任务ID: force-task-001
force_notify: true
```

**步骤 5.5** - 用户操作
👤 **用户请检查**: 查看你的 iPhone 是否收到通知

**步骤 5.6** - 验证
- 预期结果: 应该收到通知（force_notify 为 true）
- 如果收到通知 → ✅ 测试通过
- 如果没收到通知 → ❌ 强制通知逻辑错误

---

## 测试 6: 并发任务测试

### 测试步骤

**步骤 6.1** - 开始多个任务
```
调用 nyantify_start_task，任务ID: task-a, 名称: 任务A
调用 nyantify_start_task，任务ID: task-b, 名称: 任务B
调用 nyantify_start_task，任务ID: task-c, 名称: 任务C
```

**步骤 6.2** - 等待几秒后结束任务
```
调用 nyantify_end_task，任务ID: task-a
调用 nyantify_end_task，任务ID: task-b
调用 nyantify_end_task，任务ID: task-c
```

**步骤 6.3** - 验证
- 确认系统正确追踪多个并行任务
- 检查是否有报错信息
- 如无报错 → ✅ 测试通过

---

## 测试总结

| 测试 | 功能 | 预期结果 |
|------|------|----------|
| 测试1 | 直接通知 | ✅ 立即收到通知 |
| 测试2 | 短任务 | ✅ 不收到通知 |
| 测试3 | 长任务+离开IDE | ✅ 收到通知 |
| 测试4 | 长任务+在IDE | ✅ 不收到通知 |
| 测试5 | 强制通知 | ✅ 收到通知 |
| 测试6 | 并发任务 | ✅ 无报错 |

### 测试完成标准
- 所有 6 个测试都通过
- 没有错误或异常信息
- Bark 通知正常接收
- IDE 焦点检测准确

---

## 故障排除

### 问题1: 通知收不到
- 检查 Bark Key 是否正确配置
- 确认 Bark App 已安装并开启推送
- 检查网络连接

### 问题2: IDE 检测不准确
- 检查 IDE Bundle ID 是否在配置列表中
- 确认在 macOS 上运行
- 尝试手动运行 AppleScript 测试

### 问题3: 任务计时错误
- 检查系统时间是否正确
- 确认任务 ID 唯一性

---

## 自动测试命令（可选）

```bash
# 运行测试脚本
npm run test

# 或手动测试
node test/nyantify-test.js
```

